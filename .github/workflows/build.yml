name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:     
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: intall deps for fpm
      run: |
        sudo apt-get install ruby ruby-dev rubygems build-essential
        sudo gem install --no-document fpm

    - name: intall deps for apisix-dashboard
      run: |
        sudo curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
        sudo apt-get install -y nodejs

        curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
        echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
        sudo apt update
        sudo apt install -y yarn

        wget https://dl.google.com/go/go1.15.2.linux-amd64.tar.gz 
        tar -xzf go1.15.2.linux-amd64.tar.gz
        sudo mv go /usr/local

        export GO111MODULE=on
        export GOROOT=/usr/local/go 
        export GOPATH=$HOME/gopath
        export PATH=$PATH:$GOROOT/bin:$GOPATH/bin

        mkdir gopath

    - name: build apisix-dashboard
      run: |
        ./dashboard-rpm.sh
